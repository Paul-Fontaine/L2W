<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
    <head>
        <meta charset="UTF-8">
        <title>Liste des collectes</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
        <link href="first.css" rel="stylesheet">
        <link href="liste_collecte.css" rel="stylesheet">
    </head>
    <body>
        <header>
            <h1><a href="index.html" style="color: inherit; text-decoration: none;">L2W</a></h1>
            <nav>
                <a href="index.html">Accueil</a>
                <a href="form.html">Cr√©er</a>
                <a href="liste_collecte.html">Rejoindre</a>
                <a href="connexion.html">Se connecter</a>
            </nav>
        </header>

        <main class="collectes-container">
            <div id="collectesContent">
                <p>Chargement des collectes...</p>
            </div>
        </main>

        <script>
            document.addEventListener("DOMContentLoaded", () => {
                const container = document.getElementById("collectesContent");

                // Charger events.json et fusionner avec localStorage
                fetch("events.json")
                    .then(response => response.json())
                    .then(jsonData => {
                        // Charger localStorage s'il existe
                        let mergedData = { events: { ...jsonData.events } };
                        
                        try {
                            const storedData = localStorage.getItem("eventsData");
                            if (storedData) {
                                const parsedStored = JSON.parse(storedData);
                                if (parsedStored && parsedStored.events) {
                                    // Fusionner : events.json en base, localStorage en compl√©ment
                                    mergedData.events = { ...jsonData.events, ...parsedStored.events };
                                }
                            }
                        } catch (e) {
                            console.warn("Erreur lors du chargement de localStorage, utilisation de events.json uniquement", e);
                        }

                        const events = mergedData.events || {};

                        if (Object.keys(events).length === 0) {
                            container.innerHTML = `
                                <div class="no-collectes">
                                    <h2>Aucune collecte disponible</h2>
                                    <p>Il n'y a pas encore d'√©v√©nements de ramassage organis√©s.</p>
                                    <p>Cr√©ez-en un d√®s maintenant !</p>
                                </div>
                            `;
                            return;
                        }

                        const html = `
                            <h2>Liste des collectes</h2>
                            <ul class="collecte-list">
                                ${Object.entries(events).map(([eventName, eventDetails]) => {
                                    const lieu = eventDetails.lieu || "Lieu non sp√©cifi√©";
                                    const organisateur = eventDetails.organisateur || "Organisateur non sp√©cifi√©";
                                    const date = eventDetails.date_debut || "Date non sp√©cifi√©e";
                                    const adresse = eventDetails.adresse || "";
                                    
                                    // Calculer le nombre total de participants (somme des nombres)
                                    let totalParticipants = 0;
                                    if (eventDetails.participants) {
                                        Object.values(eventDetails.participants).forEach(participant => {
                                            // G√©rer les deux formats : objet {nombre: "1"} ou string "1"
                                            if (typeof participant === 'object' && participant !== null) {
                                                // Format objet avec propri√©t√© nombre
                                                const nombre = parseInt(participant.nombre || participant.nombre_participants || "0", 10);
                                                totalParticipants += isNaN(nombre) ? 0 : nombre;
                                            } else {
                                                // Format string direct
                                                const nombre = parseInt(participant || "0", 10);
                                                totalParticipants += isNaN(nombre) ? 0 : nombre;
                                            }
                                        });
                                    }
                                    const participantsCount = totalParticipants;

                                    return `
                                    <li>
                                        <a href="info_collecte.html?collecte=${encodeURIComponent(eventName)}" class="collecte-card">
                                            <span class="collecte-title">${eventName}</span>
                                            <div class="collecte-info-item">
                                                <strong>üìç Lieu :</strong>
                                                <span>${lieu}${adresse ? ` - ${adresse}` : ''}</span>
                                            </div>
                                            <div class="collecte-info-item">
                                                <strong>üë§ Organisateur :</strong>
                                                <span>${organisateur}</span>
                                            </div>
                                            <div class="collecte-info-item">
                                                <strong>üìÖ Date :</strong>
                                                <span>${date}</span>
                                            </div>
                                            ${participantsCount > 0 ? `
                                            <div class="collecte-info-item">
                                                <strong>üë• Participants :</strong>
                                                <span>${participantsCount} personne${participantsCount > 1 ? 's' : ''}</span>
                                            </div>
                                            ` : ''}
                                            <span class="collecte-badge">Voir les d√©tails ‚Üí</span>
                                        </a>
                                    </li>
                                    `;
                                }).join("")}
                            </ul>
                        `;
                        container.innerHTML = html;
                    })
                    .catch(error => {
                        console.error("Erreur lors du chargement du JSON:", error);
                        container.innerHTML = `
                            <div class="no-collectes">
                                <h2>Erreur de chargement</h2>
                                <p>Impossible de charger les collectes. Veuillez r√©essayer plus tard.</p>
                            </div>
                        `;
                    });
            });
        </script>

    </body>
</html>